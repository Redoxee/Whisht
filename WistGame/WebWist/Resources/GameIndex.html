<!doctype html>
<style>
    textarea {
        vertical-align: bottom;
    }

    #output {
        overflow: auto;
        float: right;
        border: 1pt;
        border-color: black;
        border-style: solid;
        min-width: 300pt;
    }

    #output > p {
        overflow-wrap: break-word;
    }

    #output span {
        color: blue;
    }

    #output span.error {
        color: red;
    }
</style>
<h2>Whist</h2>
<div id=playArea></div>
<textarea cols=60 rows=1></textarea>
<button>Connect</button>
<div id=output></div>
<script>
    var button = document.querySelector("button"),
        output = document.querySelector("#output"),
        textarea = document.querySelector("textarea"),
        // wsUri = "ws://echo.websocket.org/",
        websocket = null,
        isConnected = false;
    var playArea = document.querySelector("#playArea");
    var gameWebSocketUrl = document.URL.replace("http://", "ws://");

    var playerIndex = -1;
    var currentState = "None";
    var availableSlots = [];
    writeToScreen("WS URI " + gameWebSocketUrl);

    createWebSocket();

    function doSend(message) {
        writeToScreen("SENT: " + message);
        websocket.send(message);
    }

    function writeToScreen(message) {
        output.insertAdjacentHTML("afterbegin", "<p>" + message + "</p>");
    }

    function recieveWebSocketMessage(e) {
        var messageData = null;
        writeToScreen("Recieving message " + e.data);
        try {
            messageData = JSON.parse(e.data);
        }
        catch (error)
        {
            writeToScreen("error while parsing json" + error.message);
        }

        writeToScreen(messageData.StateID);

        if (messageData.MessageType == "AvailablePlayerSlots")
        {
            handleAvailablePlayerSlots(messageData);
        }
    }

    function createWebSocket() {
        console.log(gameWebSocketUrl);
        websocket = new WebSocket(gameWebSocketUrl);

        button.addEventListener("click", onClickButton);

        websocket.onopen = function (e) {
            if (!isConnected) {
                button.innerHTML = "Send";
            }

            isConnected = true;
            writeToScreen("CONNECTED");
            var requestPlayerSlots = '{ "OrderType": "RequestPlayerSlots" }';
            doSend(requestPlayerSlots);
        };

        websocket.onclose = function (e) {
            writeToScreen("DISCONNECTED");
        };

        websocket.onmessage = recieveWebSocketMessage;

        websocket.onerror = function (e) {
            writeToScreen("<span class=error>ERROR:</span> " + e.data);
        };
    }

    function clearPlayArea()
    {
        while (playArea.firstChild)
        {
            playArea.removeChild(playArea.firstChild)
        }
    }

    function handleAvailablePlayerSlots(messageData)
    {
        availableSlots = messageData.AvaialablePlayerSlots;

        if (playerIndex < 0)
        {
            clearPlayArea();
            var numberOfSlots = 0;
            if (availableSlots.length > 0)
            {
                var table = document.createElement("table");
                var tr = document.createElement("tr");
                table.appendChild(tr);
                for (var index = 0; index < availableSlots.length; ++index) {
                    if (availableSlots[index]) {
                        numberOfSlots++;
                        var th = document.createElement("th");
                        var playerSlotButton = document.createElement("button");
                        th.appendChild(playerSlotButton);
                        tr.appendChild(th);

                        playerSlotButton.appendChild(document.createTextNode("Player " + (index + 1)));
                        (function(i) {
                            playerSlotButton.addEventListener("click", function () {
                                requestPlayerSlots(i);
                            })
                        })(index);
                    }
                }

                if (numberOfSlots >= 0) {
                    playArea.appendChild(table);
                }
            }

            if (numberOfSlots <= 0)
            {
                var p = document.createElement("p").appendChild(document.createElement("No more slots available"));
                playArea.appendChild(p);
            }
        }
    }

    function onClickButton() {
        if (isConnected) {

            var text = textarea.value;

            text && doSend(text);
            textarea.value = "";
            textarea.focus();
        }
        else {
            createWebSocket();
        }
    }

    function requestPlayerSlots(requestedIndex) {
        writeToScreen("Clicked request player index " + requestedIndex);
        if (playerIndex >= 0) {
            writeToScreen("Player index is already " + playerIndex);
            return;
        }

        if (!availableSlots[requestedIndex]) {
            return;
        }

        var requestPlayerIndex = '{"OrderType":"SelectPlayerSlot", "PlayerIndex": ' + requestedIndex + '}';
        doSend(requestPlayerIndex);
    }

</script>